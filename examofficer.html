<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Learner Scores - Green Edgewood Academy</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <style>
    body {
      font-family: Arial, sans-serif;
      background: #f4f8fb;
      padding: 20px;
    }
    h1, h2, h3 {
      color: #004466;
    }
    input, select, button {
      margin: 5px;
      padding: 10px;
      font-size: 14px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px;
      text-align: left;
    }
    th {
      background: #0074A2;
      color: #fff;
    }
    section {
      margin-bottom: 40px;
      background: #fff;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    }
  </style>
</head>
<body>

<h1>Learner Subject Scores - Green Edgewood Academy</h1>

<form id="studentForm" onsubmit="addOrUpdateScore(event)">
  <input name="adm" placeholder="Admission No" required />
  <input name="name" placeholder="Full Name" required />
  <select name="grade" required>
    <option value="pp1">PP1</option>
    <option value="pp2">PP2</option>
    <option value="grade1">Grade 1</option>
    <option value="grade2">Grade 2</option>
    <option value="grade3">Grade 3</option>
    <option value="grade4">Grade 4</option>
    <option value="grade5">Grade 5</option>
    <option value="grade6">Grade 6</option>
    <option value="grade7">Grade 7</option>
  </select>
  <select name="term" required>
    <option value="term1">Term 1</option>
    <option value="term2">Term 2</option>
    <option value="term3">Term 3</option>
  </select><br/>

  <input name="english" type="number" placeholder="English" min="0" max="100" />
  <input name="kiswahili" type="number" placeholder="Kiswahili" min="0" max="100" />
  <input name="math" type="number" placeholder="Mathematics" min="0" max="100" />
  <input name="science" type="number" placeholder="Science" min="0" max="100" />
  <input name="sst" type="number" placeholder="Social Studies" min="0" max="100" />
  <input name="cre" type="number" placeholder="CRE" min="0" max="100" />
  <input name="art" type="number" placeholder="Art & Craft" min="0" max="100" />
  <input name="music" type="number" placeholder="Music" min="0" max="100" />
  <input name="pe" type="number" placeholder="P.E" min="0" max="100" />
  <br/>
  <button type="submit">Add/Update</button>
</form>

<input type="text" id="searchInput" placeholder="Search by Name or Admission No" onkeyup="searchScores()" style="width: 100%; margin-top: 20px;">

<div id="tablesContainer"></div>

<script>
const grades = ["pp1","pp2","grade1","grade2","grade3","grade4","grade5","grade6","grade7"];
const terms = ["term1","term2","term3"];
const subjects = ["english","kiswahili","math","science","sst","cre","art","music","pe"];
const gradeLabels = {
  pp1:"PP1", pp2:"PP2", grade1:"Grade 1", grade2:"Grade 2", grade3:"Grade 3",
  grade4:"Grade 4", grade5:"Grade 5", grade6:"Grade 6", grade7:"Grade 7"
};
let scores = JSON.parse(localStorage.getItem("cbcScores") || "[]");

function getGrade(mark) {
  if (mark >= 80) return "A";
  if (mark >= 70) return "B";
  if (mark >= 60) return "C";
  if (mark >= 50) return "D";
  if (mark >= 40) return "E";
  return "F";
}

function addOrUpdateScore(event) {
  event.preventDefault();
  const form = event.target;
  const data = Object.fromEntries(new FormData(form).entries());
  data.total = subjects.reduce((sum, sub) => sum + (parseInt(data[sub]) || 0), 0);
  const index = scores.findIndex(s => s.adm === data.adm && s.term === data.term && s.grade === data.grade);
  if (index > -1) scores[index] = data;
  else scores.push(data);
  localStorage.setItem("cbcScores", JSON.stringify(scores));
  form.reset();
  createTables();
}

function createTables() {
  const container = document.getElementById("tablesContainer");
  container.innerHTML = "";
  grades.forEach(grade => {
    const section = document.createElement("section");
    section.innerHTML = `<h2>${gradeLabels[grade]} Learner Scores</h2>`;
    terms.forEach(term => {
      const tableId = `${grade}_${term}`;
      section.innerHTML += `
        <h3>${term.replace("term", "Term ")}</h3>
        <table id="${tableId}Table">
          <thead>
            <tr>
              <th>No</th><th>Adm No</th><th>Name</th>
              ${subjects.map(s => `<th>${s.charAt(0).toUpperCase() + s.slice(1)}</th>`).join("")}
              <th>Total</th><th>PDF</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
        <button onclick="downloadExcel('${tableId}')">Download Excel</button>
      `;
    });

    if (grade === "grade7") {
      const deleteBtn = document.createElement("button");
      deleteBtn.textContent = "Delete Learner by Adm No";
      deleteBtn.style.marginTop = "20px";
      deleteBtn.onclick = () => {
        const adm = prompt("Enter Admission Number to Delete:");
        if (adm) deleteLearnerByAdm(adm.trim());
      };
      section.appendChild(deleteBtn);
    }

    container.appendChild(section);
  });
  displayScores();
}

function displayScores(filter = "") {
  grades.forEach(g => {
    terms.forEach(t => {
      const tableId = `${g}_${t}`;
      const tbody = document.getElementById(`${tableId}Table`).querySelector("tbody");
      tbody.innerHTML = "";
      const filteredScores = scores
        .filter(s => s.grade === g && s.term === t)
        .filter(s => s.name.toLowerCase().includes(filter) || s.adm.includes(filter))
        .sort((a, b) => b.total - a.total);
      filteredScores.forEach((s, i) => {
        const row = tbody.insertRow();
        row.innerHTML = `
          <td>${i + 1}</td>
          <td>${s.adm}</td>
          <td>${s.name}</td>
          ${subjects.map(sub => `<td>${s[sub] ? s[sub] + "%" : ""}</td>`).join("")}
          <td>${s.total}</td>
          <td><button onclick='downloadLearnerPDF(${JSON.stringify(s)}, ${i + 1}, ${filteredScores.length})'>PDF</button></td>
        `;
      });
    });
  });
}

function deleteLearnerByAdm(adm) {
  const initialLength = scores.length;
  scores = scores.filter(s => s.adm !== adm);
  if (scores.length < initialLength) {
    localStorage.setItem("cbcScores", JSON.stringify(scores));
    alert(`Learner with Admission No ${adm} deleted.`);
    createTables();
  } else {
    alert(`No learner found with Admission No ${adm}.`);
  }
}

function downloadLearnerPDF(learner, position, totalLearners) {
  const { jsPDF } = window.jspdf;
  const doc = new jsPDF();
  const gradeText = gradeLabels[learner.grade];
  const termText = learner.term.replace("term", "Term ");

  const logoBase64 = localStorage.getItem("logoBase64");
  if (logoBase64) {
    doc.addImage(logoBase64, 'PNG', 10, 5, 30, 30);
  }

  doc.setFontSize(16);
  doc.text("GREEN EDGEWOOD ACADEMY", 60, 15);
  doc.setFontSize(14);
  doc.text("CBC LEARNER REPORT", 75, 25);

  doc.setFontSize(12);
  doc.text(`Adm No: ${learner.adm}`, 20, 40);
  doc.text(`Name: ${learner.name}`, 20, 48);
  doc.text(`Class: ${gradeText}`, 20, 56);
  doc.text(`Term: ${termText}`, 20, 64);

  doc.autoTable({
    startY: 80,
    head: [["Subject", "Marks (%)", "Grade"]],
    body: subjects.map(sub => {
      const mark = learner[sub];
      return [
        sub.charAt(0).toUpperCase() + sub.slice(1),
        mark ? mark + "%" : "",
        mark ? getGrade(parseInt(mark)) : ""
      ];
    }),
    theme: 'grid',
    styles: { fontSize: 11, halign: 'center' },
    headStyles: { fillColor: [0, 116, 162] }
  });

  const finalY = doc.lastAutoTable.finalY + 10;
  doc.text(`Total Marks: ${learner.total}`, 20, finalY);
  doc.text(`Position: ${position} of ${totalLearners}`, 20, finalY + 8);
  doc.text("Teacher's Comment:", 20, finalY + 18);
  doc.rect(20, finalY + 20, 170, 20);
  doc.text("Signature:", 20, finalY + 48);
  doc.rect(40, finalY + 45, 60, 8);
  doc.text("Opening Date:", 110, finalY + 48);
  doc.rect(140, finalY + 45, 50, 8);

  doc.save(`${learner.adm}_cbc_report.pdf`);
}

function downloadExcel(tableId) {
  const table = document.getElementById(`${tableId}Table`);
  const rows = Array.from(table.querySelectorAll("tbody tr")).map(tr => {
    const cells = tr.querySelectorAll("td");
    const adm = cells[1].innerText;
    const name = cells[2].innerText;
    const subjectScores = subjects.map((_, i) => {
      const raw = cells[i + 3].innerText.replace('%', '').trim();
      const score = raw === "" ? "" : parseInt(raw);
      return [score === "" ? "" : score, score === "" ? "" : getGrade(score)];
    });
    const total = parseInt(cells[cells.length - 3].innerText);
    return [cells[0].innerText, adm, name, ...subjectScores.flat(), total];
  });

  const headers = ["No", "Adm No", "Name"];
  subjects.forEach(s => {
    headers.push(`${s.charAt(0).toUpperCase() + s.slice(1)} (%)`);
    headers.push(`${s.charAt(0).toUpperCase() + s.slice(1)} Grade`);
  });
  headers.push("Total");

  const ws = XLSX.utils.aoa_to_sheet([headers, ...rows]);
  const wb = XLSX.utils.book_new();
  XLSX.utils.book_append_sheet(wb, ws, tableId);
  XLSX.writeFile(wb, `${tableId}.xlsx`);
}

function searchScores() {
  const query = document.getElementById("searchInput").value.toLowerCase();
  displayScores(query);
}

window.onload = createTables;
</script>

</body>
</html>
